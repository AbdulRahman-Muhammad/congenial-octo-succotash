name: Workflow App

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        runner: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tor tor-geoipdb \
            libnss3 libnspr4 libcups2 libatk1.0-0 libatk-bridge2.0-0 \
            libatspi2.0-0 libxcomposite1 libxdamage1 libxrandr2 \
            libgbm1 libxkbcommon0 curl geoip-bin geoip-database net-tools

      - name: Create Data Directory
        run: |
          mkdir -p /home/runner/.runner-${{ matrix.runner }}
          sudo chown -R $USER:$USER /home/runner/.runner-${{ matrix.runner }}
          sudo chmod 700 /home/runner/.runner-${{ matrix.runner }}
          echo "Created Data Directory for runner ${{ matrix.runner }}"

      - name: Configure and Start
        run: |
          SOCKS_PORT=$((9050 + ${{ matrix.runner }}))
          CONTROL_PORT=$((9150 + ${{ matrix.runner }}))
          sudo bash -c 'cat > /home/runner/.runner-${{ matrix.runner }}/torrc <<EOF
          ExitNodes {jp}
          StrictNodes 1
          SocksPort $SOCKS_PORT
          ControlPort $CONTROL_PORT
          CookieAuthentication 1
          DataDirectory /home/runner/.runner-${{ matrix.runner }}
          GeoIPFile /usr/share/tor/geoip
          GeoIPv6File /usr/share/tor/geoip6
          Log notice stdout
          EOF'

          echo "üöÄ Starting..."
          tor -f /etc/tor/torrc &
          TOR_PID=$!

          echo "‚è≥ Waiting for bootstrap..."
          for i in {1..15}; do
            if sudo netstat -tlnp | grep -q "9050.*tor"; then
              echo "‚úÖ Running on 127.0.0.1:9050"
              break
            fi
            echo "Waiting for for 9050... ($i/15)"
            sleep 8
          done

      - name: Verification
        run: |
          echo "üåê Checking..."
          sudo apt-get install -y torsocks > /dev/null
          sleep 5
          EXIT_IP=$(torsocks curl -s https://api.ipify.org || echo "connection_failed")
          if [ "$EXIT_IP" = "connection_failed" ]; then
            echo "‚ùå First attempt failed. Retrying..."
            sleep 20
            EXIT_IP=$(torsocks curl -s https://api.ipify.org || echo "failed")
          fi
          echo "‚úÖ Final: $EXIT_IP"
          echo "üåè Location (via geoiplookup):"
          geoiplookup "$EXIT_IP" || true

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install stem playwright
          playwright install chromium

      - name: Run App
        env:
          CONTROL_PORT: $CONTROL_PORT
          TARGET_URL: "https://colle-pedia.blogspot.com/"
          RUNNER_ID: ${{ matrix.runner }}
          PROXY_URL: "socks5://127.0.0.1:$SOCKS_PORT"
        run: python app.py
